<!doctype html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>TorqSpec Pro • Aviation Torque Calculator</title>
<meta name="description" content="Professional aviation torque calculator with range input, OEM rounding, setpoint guidance, gauges, and offline capability.">
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b0f14">
<style>
  :root{
    --bg:#0b0f14; --bg-alt:#0e141b; --text:#e6edf3; --muted:#9fb1c1; --accent:#4ea1ff;
    --ok:#2ecc71; --warn:#f1c40f; --bad:#e74c3c; --card:#101720; --border:#223041;
    --shadow:0 6px 24px rgba(0,0,0,.35); --focus:2px solid var(--accent);
    --btn:#142233; --btntext:#e6edf3;
  }
  [data-theme="light"]{
    --bg:#f7f9fc; --bg-alt:#ffffff; --text:#1a2430; --muted:#5b6b79; --accent:#0b6bcb;
    --ok:#1c7f43; --warn:#9a7b00; --bad:#a63b2f; --card:#ffffff; --border:#d6e0ea;
    --shadow:0 6px 18px rgba(0,0,0,.08); --btn:#0b6bcb; --btntext:#ffffff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial;
    background:linear-gradient(135deg,var(--bg),var(--bg-alt)); color:var(--text); line-height:1.4;
  }
  /* Phone-centric layout */
  .shell{display:flex; justify-content:center;}
  .wrap{width:100%; max-width:420px; margin:0 auto; padding:12px 12px 24px}
  header{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px}
  .brand{display:flex; flex-direction:column; gap:2px}
  h1{font-size:1.05rem; margin:0; line-height:1.1}
  .badge{font-size:.7rem; padding:2px 8px; border-radius:999px; border:1px solid var(--border); color:var(--muted); display:inline-block}
  .toolbar{display:flex; gap:6px; align-items:center}
  .btn, button{background:var(--btn); color:var(--btntext); border:1px solid var(--border); border-radius:10px; padding:8px 10px; cursor:pointer}
  .btn:focus-visible{outline:var(--focus)}
  .iconbtn{display:inline-flex; align-items:center; justify-content:center; width:38px; height:38px; padding:0; border-radius:10px}
  .menu{position:relative}
  .menu-panel{
    position:absolute; right:0; top:46px; width:min(90vw,320px);
    background:var(--card); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow);
    padding:10px; display:none; z-index:10
  }
  .menu.open .menu-panel{display:block}
  .menu .row{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px 0}
  .toggle{display:inline-flex; align-items:center; gap:8px}
  .toggle input{accent-color:var(--accent)}
  .card{background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:12px}
  label{display:block; font-size:.85rem; color:var(--muted); margin-bottom:6px}
  input[type="text"],input[type="number"],select{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
    background-color:var(--card); color:var(--text); appearance:none;
  }
  select:focus-visible, input:focus-visible{outline:var(--focus)}
  input::placeholder{color:var(--muted)}
  .rowflex{display:flex; align-items:center; gap:10px; justify-content:space-between; padding:10px 0; border-bottom:1px dashed var(--border); flex-wrap:wrap}
  .rowflex:last-child{border-bottom:0}
  .unit{min-width:110px; font-weight:600}
  .val{font-variant-numeric:tabular-nums}
  .delta{font-size:.85rem; color:var(--muted)}
  .footer{margin-top:16px; font-size:.85rem; color:var(--muted)}
  .pill{display:inline-block; font-size:.72rem; padding:2px 8px; border-radius:999px; border:1px solid var(--border); color:var(--muted)}
  .ok{border-color:var(--ok); color:var(--ok)} .attn{border-color:var(--warn); color:var(--warn)} .risk{border-color:var(--bad); color:var(--bad)}
  /* Gauge */
  .gauge{margin:10px 0 4px; background:linear-gradient(90deg,#556,#667); border:1px solid var(--border); border-radius:10px; height:14px; position:relative; overflow:hidden}
  [data-theme="light"] .gauge{background:linear-gradient(90deg,#e7edf4,#eef2f7)}
  .gmark{position:absolute; top:0; bottom:0; width:2px; background:var(--border)}
  .needle{position:absolute; top:-4px; width:0; height:0; border-left:6px solid transparent; border-right:6px solid transparent; border-bottom:8px solid var(--accent); transform:translateX(-50%); transition:left .25s ease}
  .glabel{font-size:.78rem; color:var(--muted); display:flex; justify-content:space-between; margin-top:4px}
  /* Hide options section by default (inside hamburger) */
  .controls{display:grid; gap:10px; grid-template-columns:1fr; margin:8px 0 12px}
  
  /* Disclaimer styles */
  .disclaimer-link {
    color: var(--muted);
    text-decoration: underline;
    cursor: pointer;
    font-size: 11px;
    opacity: 0.7;
    transition: opacity 0.2s;
  }
  .disclaimer-link:hover { opacity: 1; }

  /* Modal styles */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    animation: fadeIn 0.3s;
  }
  .modal-content {
    background-color: var(--card);
    margin: 5% auto;
    padding: 20px;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
    animation: slideIn 0.3s;
    border: 1px solid var(--border);
  }
  .close {
    color: var(--muted);
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    line-height: 20px;
  }
  .close:hover { color: var(--text); }

  @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
  @keyframes slideIn { from {transform: translateY(-50px);} to {transform: translateY(0);} }

  .disclaimer-text {
    color: var(--text);
    line-height: 1.6;
    font-size: 14px;
  }
  .disclaimer-text strong { color: var(--bad); }
  
  /* Help accordion */
  .help details{margin:8px 0}
  .help summary{
    list-style:none; cursor:pointer; font-weight:600;
    display:flex; align-items:center; justify-content:space-between;
  }
  .help summary::after{content:"▾"; opacity:.7}
  .help[open] summary::after{content:"▴"}
  .help .help-body{margin-top:8px; color:var(--text)}
  .help .help-section{margin:8px 0}
  .help .help-section h3{margin:6px 0; font-size:.95rem}
  .help .help-section ul{margin:6px 0 0 18px}
  .help .help-section li{margin:6px 0}
</style>
</head>
<body>
<div class="shell">
<div class="wrap">
  <header>
    <div class="brand">
      <h1 data-i18n="title">TorqSpec Pro <span style="opacity:0.4; font-size:0.7em; font-weight:normal;">v1.5</span></h1>
      <div class="pill" id="kpi"></div>
    </div>
    <div class="toolbar">
      <div class="menu" id="menu">
        <button class="iconbtn" id="menuBtn" aria-haspopup="true" aria-expanded="false" aria-controls="menuPanel" title="Menu" aria-label="Menu">
          <!-- Hamburger icon -->
          <svg width="22" height="22" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <rect x="2" y="4" width="16" height="2" rx="1" fill="currentColor"/><rect x="2" y="9" width="16" height="2" rx="1" fill="currentColor"/><rect x="2" y="14" width="16" height="2" rx="1" fill="currentColor"/>
          </svg>
        </button>
        <div class="menu-panel" id="menuPanel">
          <div class="row">
            <span data-i18n="oemRounding">OEM Rounding</span>
            <label class="toggle"><input type="checkbox" id="oemRounding"></label>
          </div>
          <div class="row">
            <span data-i18n="theme">Theme</span>
            <button id="themeBtn" class="btn" data-i18n="themeBtn">Light</button>
          </div>
          <div class="row">
            <span data-i18n="language">Language</span>
            <button id="langBtn" class="btn">ES</button>
          </div>
          <div class="row">
            <span>Install</span>
            <button id="installBtn" class="btn" hidden data-i18n="install">Install</button>
          </div>
          <div class="row">
            <span>Help</span>
            <button id="helpBtn" class="btn">Open</button>
          </div>
          <div class="row">
            <span data-i18n="shareApp">Share App</span>
            <button id="shareBtn" class="btn" data-i18n="share">Share</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main input lives outside menu for speed -->
  <section class="card controls" aria-label="Inputs">
    <div>
      <label for="valueLow" data-i18n="valueLow">Torque Value (or Low)</label>
      <input id="valueLow" type="number" inputmode="decimal" step="any" min="0" placeholder="e.g., 12.5">
    </div>
    <div>
      <label for="valueHigh" data-i18n="valueHigh">High Value (optional)</label>
      <input id="valueHigh" type="number" inputmode="decimal" step="any" min="0" placeholder="Leave blank for single value">
      <div id="valueHelp" class="footer" data-i18n="valueHelp">Enter <b>Low</b> only for single value, or <b>both</b> for a range.</div>
    </div>
    <div>
      <label for="fromUnit" data-i18n="fromUnit">From Unit</label>
      <select id="fromUnit" aria-label="From unit">
        <option value="Nm">N·m</option>
        <option value="lbf_in">lbf·in</option>
        <option value="lbf_ft">lbf·ft</option>
        <option value="kgf_m">kgf·m</option>
        <option value="oz_in">oz·in</option>
        <option value="dNm">dN·m</option>
        <option value="Ncm">N·cm</option>
      </select>
    </div>
    <div>
      <label for="toolUnit" data-i18n="toolUnit">Tool Unit (Wrench)</label>
      <select id="toolUnit" aria-label="Tool unit">
        <option value="from" data-i18n="sameAsFrom">Same as From</option>
        <option value="Nm">N·m</option>
        <option value="lbf_in">lbf·in</option>
        <option value="lbf_ft">lbf·ft</option>
        <option value="kgf_m">kgf·m</option>
        <option value="oz_in">oz·in</option>
        <option value="dNm">dN·m</option>
        <option value="Ncm">N·cm</option>
      </select>
      <div class="footer" data-i18n="toolUnitHelp">Set to the units on your torque wrench.</div>
    </div>
    <div>
      <label for="resolution" data-i18n="resolution">Tool Resolution</label>
      <input id="resolution" type="number" step="any" min="0" placeholder="e.g., 0.1 for N·m, 1 for lbf·in">
      <div class="footer" data-i18n="resolutionHelp">Graduation size on your wrench (leave blank to skip setpoint rounding).</div>
    </div>
    <div>
      <label for="policy" data-i18n="policy">Rounding Policy</label>
      <select id="policy">
        <option value="nearest" data-i18n="nearest">Nearest</option>
        <option value="up" data-i18n="up">Round Up</option>
        <option value="down" data-i18n="down">Round Down</option>
      </select>
      <div class="footer" data-i18n="policyHelp">QA/SOP may require a specific policy.</div>
    </div>
  </section>

  <section class="card" aria-live="polite" aria-atomic="true">
    <div id="gaugeWrap" hidden>
      <div class="gauge" id="gauge">
        <div class="gmark" id="gLo"></div>
        <div class="gmark" id="gMd"></div>
        <div class="gmark" id="gHi"></div>
        <div class="needle" id="needle" title="Setpoint"></div>
      </div>
      <div class="glabel"><span id="gLoL"></span><span id="gMdL"></span><span id="gHiL"></span></div>
    </div>

    <div class="rowflex">
      <div class="unit" data-i18n="status">Status</div>
      <div class="val" id="statusText" data-i18n="enterToBegin">Enter a value to begin.</div>
    </div>
    <div id="results"></div>
  </section>

  <p class="footer" data-i18n="disclaimer">
    Conversions and setpoints are <b>reference only</b>. Always use approved data (AMM/SRM/CMM/IPC) and calibrated tools. Follow your organization's procedures.
  </p>

  <div class="footer" style="text-align:center; margin-top:12px; padding-top:12px; border-top:1px solid var(--border);">
    <span id="copyright">© Ciphracore Systems LLC — All rights reserved</span><br/>
    <a href="mailto:ciphracore@protonmail.com" style="color:inherit;">ciphracore@protonmail.com</a><br/>
    <span class="disclaimer-link" id="disclaimerLink">**For reference and educational purposes only** - Click for details</span>
  </div>

  <section class="card help" id="help">
    <details>
      <summary><span data-i18n="helpTitle">Help / User Manual</span></summary>
      <div class="help-body">
        <p data-i18n="helpIntro">
          The ☰ menu (top-right) contains all options. This guide explains each control.
        </p>

        <div class="help-section">
          <h3 data-i18n="helpMenuHeader">Menu Controls</h3>
          <ul>
            <li data-i18n="helpItemOEM"><b>OEM Rounding</b> — ON uses typical OEM increments; OFF shows exact values with your chosen policy.</li>
            <li data-i18n="helpItemTheme"><b>Theme</b> — Button shows the <i>target</i> mode. "Light" switches to Light, "Dark" switches to Dark.</li>
            <li data-i18n="helpItemLang"><b>Language</b> — Toggle English ↔ Español. Preference is saved.</li>
            <li data-i18n="helpItemInstall"><b>Install</b> — Adds this tool as a PWA for offline, app-like use.</li>
          </ul>
        </div>

        <div class="help-section">
          <h3 data-i18n="helpNotesHeader">Notes</h3>
          <ul>
            <li data-i18n="helpNoteLayout">Mobile layout: width is phone-sized; content scrolls vertically.</li>
            <li data-i18n="helpNotePrefs">Preferences (theme/language) are saved for next sessions.</li>
            <li data-i18n="helpNoteOffline">Offline mode works after first load or installation.</li>
          </ul>
        </div>
      </div>
    </details>
  </section>
</div>
</div>

<!-- Disclaimer Modal -->
<div id="disclaimerModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3 style="color: var(--bad); margin-top: 0;">Important Legal Disclaimer</h3>
    <div class="disclaimer-text">
      <p><strong>Disclaimer:</strong> This application is provided <strong>for reference and educational purposes only</strong>. It is <strong>not an FAA-, EASA-, or OEM-approved source of maintenance data</strong>, and it <strong>must not be used as instructions for continued airworthiness, inspection, or repair</strong>.</p>
      
      <p>All torque values, conversions, and calculations must be verified against the applicable <strong>Aircraft Maintenance Manual (AMM), Structural Repair Manual (SRM), Component Maintenance Manual (CMM), or other manufacturer-approved documents</strong> before use.</p>
      
      <p>The developer makes <strong>no warranties, express or implied</strong>, and assumes <strong>no liability for errors, omissions, or misuse</strong> of this application.</p>
      
      <p>By using this application, you acknowledge that <strong>you are solely responsible for compliance with all regulatory and manufacturer requirements</strong>.</p>
      
      <p><strong>Safety Notice:</strong> Torque values in this calculator are intentionally rounded UP to provide a slight safety margin. Always verify proper torque specifications and procedures with approved maintenance documentation.</p>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = s=>document.querySelector(s);
  // Elements
  const results = $("#results"), valueLow=$("#valueLow"), valueHigh=$("#valueHigh"), fromUnit=$("#fromUnit"), toolUnit=$("#toolUnit"), resolution=$("#resolution"), policy=$("#policy");
  const oemRounding=$("#oemRounding"), statusText=$("#statusText"), themeBtn=$("#themeBtn"), langBtn=$("#langBtn"), kpi=$("#kpi");
  const gaugeWrap=$("#gaugeWrap"), gLo=$("#gLo"), gMd=$("#gMd"), gHi=$("#gHi"), needle=$("#needle"), gLoL=$("#gLoL"), gMdL=$("#gMdL"), gHiL=$("#gHiL");
  const menu=$("#menu"), menuBtn=$("#menuBtn"), menuPanel=$("#menuPanel");

  // Simple i18n
  const dict = {
    en: {
      title: "TorqSpec Pro <span style='opacity:0.4; font-size:0.7em; font-weight:normal;'>v1.5</span>",
      oemRounding: "OEM Rounding", theme: "Theme", themeBtnLight: "Light", themeBtnDark: "Dark",
      language: "Language", install: "Install", shareApp: "Share App", share: "Share",
      valueLow: "Torque Value (or Low)", valueHigh: "High Value (optional)",
      valueHelp: "Enter <b>Low</b> only for single value, or <b>both</b> for a range.",
      fromUnit: "From Unit", toolUnit: "Tool Unit (Wrench)", sameAsFrom:"Same as From", toolUnitHelp:"Set to the units on your torque wrench.",
      resolution: "Tool Resolution", resolutionHelp:"Graduation size on your wrench (leave blank to skip setpoint rounding).",
      policy: "Rounding Policy", nearest: "Nearest", up:"Round Up", down:"Round Down", policyHelp:"QA/SOP may require a specific policy.",
      status:"Status", enterToBegin:"Enter a value to begin.", disclaimer:"Conversions and setpoints are <b>reference only</b>. Always use approved data (AMM/SRM/CMM/IPC) and calibrated tools. Follow your organization's procedures.",
      helpTitle: "Help / User Manual",
      helpIntro: "The ☰ menu (top-right) contains all options. This guide explains each control.",
      helpMenuHeader: "Menu Controls",
      helpItemOEM: "<b>OEM Rounding</b> — ON uses typical OEM increments; OFF shows exact values with your chosen policy.",
      helpItemTheme: "<b>Theme</b> — Button shows the <i>target</i> mode. \"Light\" switches to Light, \"Dark\" switches to Dark.",
      helpItemLang: "<b>Language</b> — Toggle English ↔ Español. Preference is saved.",
      helpItemInstall: "<b>Install</b> — Adds this tool as a PWA for offline, app-like use.",
      helpNotesHeader: "Notes",
      helpNoteLayout: "Mobile layout: width is phone-sized; content scrolls vertically.",
      helpNotePrefs: "Preferences (theme/language) are saved for next sessions.",
      helpNoteOffline: "Offline mode works after first load or installation."
    },
    es: {
      title: "TorqSpec Pro <span style='opacity:0.4; font-size:0.7em; font-weight:normal;'>v1.5</span>",
      oemRounding: "Redondeo OEM", theme: "Tema", themeBtnLight: "Claro", themeBtnDark: "Oscuro",
      language: "Idioma", install: "Instalar", shareApp: "Compartir App", share: "Compartir",
      valueLow: "Valor de Torque (o Bajo)", valueHigh: "Valor Alto (opcional)",
      valueHelp: "Ingrese solo <b>Bajo</b> para valor único, o <b>ambos</b> para un rango.",
      fromUnit: "Unidad de origen", toolUnit: "Unidad de herramienta (llave)", sameAsFrom:"Igual que Origen", toolUnitHelp:"Ajuste a las unidades de su llave dinamométrica.",
      resolution: "Resolución de la herramienta", resolutionHelp:"Tamaño de graduación (dejar en blanco para omitir el redondeo).",
      policy: "Política de redondeo", nearest: "Más cercano", up:"Redondear arriba", down:"Redondear abajo", policyHelp:"El QA/SOP puede requerir una política específica.",
      status:"Estado", enterToBegin:"Ingrese un valor para comenzar.", disclaimer:"Las conversiones y puntos de ajuste son <b>solo de referencia</b>. Utilice siempre datos aprobados (AMM/SRM/CMM/IPC) y herramientas calibradas. Siga los procedimientos de su organización.",
      helpTitle: "Ayuda / Manual de usuario",
      helpIntro: "El menú ☰ (arriba a la derecha) contiene todas las opciones. Esta guía explica cada control.",
      helpMenuHeader: "Controles del menú",
      helpItemOEM: "<b>Redondeo OEM</b> — ACTIVADO usa incrementos típicos del manual; DESACTIVADO muestra valores exactos con su política.",
      helpItemTheme: "<b>Tema</b> — El botón muestra el modo <i>destino</i>. \"Claro\" cambia a Claro; \"Oscuro\" cambia a Oscuro.",
      helpItemLang: "<b>Idioma</b> — Cambia entre Inglés ↔ Español. La preferencia se guarda.",
      helpItemInstall: "<b>Instalar</b> — Agrega la herramienta como PWA para uso sin conexión.",
      helpNotesHeader: "Notas",
      helpNoteLayout: "Diseño móvil: ancho del tamaño de teléfono; el contenido hace scroll vertical.",
      helpNotePrefs: "Las preferencias (tema/idioma) se guardan para futuras sesiones.",
      helpNoteOffline: "El modo sin conexión funciona tras la primera carga o instalación."
    }
  };
  const langKey="torque_lang";
  function setLang(lang){
    const d = dict[lang]||dict.en;
    document.documentElement.lang = lang;
    document.querySelectorAll("[data-i18n]").forEach(el=>{
      const key = el.getAttribute("data-i18n");
      if(d[key]) el.innerHTML = d[key];
    });
    updateThemeBtnLabel();
    localStorage.setItem(langKey,lang);
  }
  setLang(localStorage.getItem(langKey)||"en");
  langBtn.addEventListener("click", ()=>{
    const now = document.documentElement.lang;
    const next = now==="en" ? "es" : "en";
    setLang(next);
    langBtn.textContent = (next==="en" ? "ES" : "EN");
  });
  langBtn.textContent = (document.documentElement.lang==="en" ? "ES" : "EN");

  // Theme with label showing TARGET mode
  const themeKey="torque_theme";
  function setTheme(t){
    document.documentElement.setAttribute("data-theme", t);
    document.querySelector('meta[name="theme-color"]').setAttribute('content', t==='dark' ? '#0b0f14' : '#f7f9fc');
    localStorage.setItem(themeKey,t);
    updateThemeBtnLabel();
  }
  function updateThemeBtnLabel(){
    const cur = document.documentElement.getAttribute("data-theme") || "dark";
    const next = (cur==="dark") ? "light" : "dark";
    const lang = document.documentElement.lang || "en";
    const label = (next==="light") ? dict[lang].themeBtnLight : dict[lang].themeBtnDark;
    themeBtn.textContent = label;
  }
  setTheme(localStorage.getItem(themeKey)||"dark");
  themeBtn.addEventListener("click", ()=>{
    const cur = document.documentElement.getAttribute("data-theme");
    setTheme(cur==="dark" ? "light" : "dark");
  });

  // Hamburger open/close
  function closeMenu(){ menu.classList.remove("open"); menuBtn.setAttribute("aria-expanded","false"); }
  menuBtn.addEventListener("click", ()=>{
    const open = menu.classList.toggle("open");
    menuBtn.setAttribute("aria-expanded", open ? "true":"false");
  });
  document.addEventListener("click", (e)=>{ if(!menu.contains(e.target)) closeMenu(); });

  // Help link in menu → scroll & open the accordion, then close menu
  const helpBtn = $("#helpBtn");
  helpBtn?.addEventListener("click", ()=>{
    const sec = $("#help details");
    if(sec && !sec.open) sec.open = true;
    $("#help").scrollIntoView({behavior:"smooth", block:"start"});
    // close hamburger
    closeMenu();
  });

  // Share App functionality
  const shareBtn = $("#shareBtn");
  shareBtn?.addEventListener("click", async ()=>{
    const url = window.location.href;
    const title = "TorqSpec Pro - Aviation Torque Calculator";
    const text = "Check out this professional aviation torque calculator with range input, setpoint guidance, and offline capability!";
    
    if (navigator.share) {
      try {
        await navigator.share({ title, text, url });
      } catch (err) {
        // User cancelled or error occurred
      }
    } else {
      // Fallback: copy to clipboard
      try {
        await navigator.clipboard.writeText(url);
        shareBtn.textContent = "Copied!";
        setTimeout(() => {
          const lang = document.documentElement.lang || "en";
          shareBtn.textContent = dict[lang].share;
        }, 1500);
      } catch (err) {
        // Fallback: show URL
        alert(`Share this link: ${url}`);
      }
    }
    closeMenu();
  });

  // PWA install
  let deferredPrompt=null;
  const installBtn = $("#installBtn");
  window.addEventListener("beforeinstallprompt", (e)=>{ e.preventDefault(); deferredPrompt=e; installBtn.hidden=false; });
  installBtn?.addEventListener("click", async()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; installBtn.hidden=true; });

  // Persist OEM rounding
  oemRounding.checked = localStorage.getItem("oem_round")==="1";
  oemRounding.addEventListener("change", ()=>{ localStorage.setItem("oem_round", oemRounding.checked ? "1" : "0"); compute(); });

  // Units
  const units = {
    "Nm":   { label:"N·m",  toNm:v=>v,               fromNm:v=>v,              oemStep:0.1 },
    "lbf_ft":{label:"lbf·ft",toNm:v=>v*1.355817948,  fromNm:v=>v*0.737562149,  oemStep:0.5 },
    "lbf_in":{label:"lbf·in",toNm:v=>v*0.112984829,  fromNm:v=>v*8.85074579,   oemStep:1   },
    "kgf_m":{ label:"kgf·m", toNm:v=>v*9.80665,      fromNm:v=>v*0.101971621,  oemStep:0.1 },
    "oz_in":{ label:"oz·in", toNm:v=>v*0.0070615518, fromNm:v=>v*141.611932,   oemStep:1   },
    "dNm":  { label:"dN·m",  toNm:v=>v*0.1,          fromNm:v=>v*10,           oemStep:0.5 },
    "Ncm":  { label:"N·cm",  toNm:v=>v*0.01,         fromNm:v=>v*100,          oemStep:1   }
  };

  function parseValueOrRange(){
    const lowVal = parseFloat(valueLow.value);
    const highVal = parseFloat(valueHigh.value);

    // No input at all
    if(!isFinite(lowVal) || lowVal < 0) return null;

    // High value provided - treat as range
    if(isFinite(highVal) && highVal >= 0){
      const lo = Math.min(lowVal, highVal);
      const hi = Math.max(lowVal, highVal);
      const mid = (lo + hi) / 2;
      return {kind:"range", lo, hi, mid};
    }

    // Only low value - single value mode
    return {kind:"single", v: lowVal};
  }
  function roundToResolution(value, step, pol){
    if(!step||step<=0) return value;
    const q=value/step;
    if(pol==="up") return Math.ceil(q)*step;
    if(pol==="down") return Math.floor(q)*step;
    return Math.round(q)*step;
  }
  function fmt(v,uKey){
    const s = oemRounding.checked ? (units[uKey].oemStep||0.1) : 0.0001;
    const dp = (s>=1) ? 0 : Math.max(0, String(s).split(".")[1]?.length||0);
    return v.toFixed(dp);
  }
  const perUnit={};
  function rowTemplate(label, exactStr, setpointStr, deltaStr, unitKey){
    const copyBtn = (perUnit[unitKey]?.hasSetpoint) ?
      `<button class="btn" data-unit="${unitKey}" aria-label="Copy setpoint for ${label}">Copy</button>` : "";
    return `<div class="rowflex">
      <div class="unit">${label}</div>
      <div class="val">${exactStr}</div>
      <div class="val">${setpointStr||""}</div>
      <div class="delta">${deltaStr||""}</div>
      ${copyBtn}
    </div>`;
  }
  function kpiBadge(deltaPct){
    if(deltaPct<=1) return '<span class="ok pill">On Target ✅</span>';
    if(deltaPct<=5) return '<span class="attn pill">Check Spec ⚠️</span>';
    return '<span class="risk pill">Review Needed ⛔</span>';
  }
  function positionWithin(lo,hi,v){
    if(hi<=lo) return 0;
    const pct=(v-lo)/(hi-lo);
    return Math.max(0,Math.min(1,pct))*100;
  }

  function compute(){
    results.innerHTML="";
    Object.keys(perUnit).forEach(k=>delete perUnit[k]);
    const parsed = parseValueOrRange();
    const fKey = fromUnit.value;
    const toolKey = (toolUnit.value==="from") ? fKey : toolUnit.value;
    const step = parseFloat(resolution.value);
    const pol = policy.value;

    if(!parsed){
      statusText.innerHTML = document.querySelector("[data-i18n='enterToBegin']").innerHTML;
      gaugeWrap.hidden=true; kpi.innerHTML=""; return;
    }

    const toNmLocal = units[fKey].toNm;
    let loNm, mdNm, hiNm, basisNm;
    if(parsed.kind==="single"){
      loNm = mdNm = hiNm = basisNm = toNmLocal(parsed.v);
      statusText.textContent = (document.documentElement.lang==="es" ? "Valor único." : "Single value.");
      gaugeWrap.hidden=true; kpi.innerHTML="";
    }else{
      loNm = toNmLocal(parsed.lo); mdNm = toNmLocal(parsed.mid); hiNm = toNmLocal(parsed.hi); basisNm = mdNm;
      statusText.textContent = (document.documentElement.lang==="es" ? "Rango detectado: Bajo / Medio / Alto." : "Range detected: Low / Mid / High.");
      gaugeWrap.hidden=false;
    }

    // KPI
    const exactTool = units[toolKey].fromNm(basisNm);
    let setTool=exactTool;
    if(isFinite(step)) setTool = roundToResolution(exactTool, step, pol);
    const deltaPct = (exactTool ? Math.abs((setTool-exactTool)/exactTool)*100 : 0);
    kpi.innerHTML = (isFinite(step)? kpiBadge(deltaPct) : "");

    // Gauge (range only)
    if(!gaugeWrap.hidden){
      const loTool = units[toolKey].fromNm(loNm), mdTool=units[toolKey].fromNm(mdNm), hiTool=units[toolKey].fromNm(hiNm);
      gLo.style.left = positionWithin(loTool,hiTool,loTool)+"%";
      gMd.style.left = positionWithin(loTool,hiTool,mdTool)+"%";
      gHi.style.left = positionWithin(loTool,hiTool,hiTool)+"%";
      needle.style.left = positionWithin(loTool,hiTool,setTool)+"%";
      gLoL.textContent = (document.documentElement.lang==="es" ? "Bajo " : "Low ") + fmt(loTool, toolKey) + " " + units[toolKey].label;
      gMdL.textContent = (document.documentElement.lang==="es" ? "Medio " : "Mid ") + fmt(mdTool, toolKey);
      gHiL.textContent = (document.documentElement.lang==="es" ? "Alto " : "High ") + fmt(hiTool, toolKey);
    }

    // Output
    Object.keys(units).forEach(k=>{
      const u=units[k]; let exactStr="", setpointStr="", deltaStr="";
      if(parsed.kind==="single"){
        const ex=u.fromNm(basisNm); exactStr=`${fmt(ex,k)} ${u.label}`;
        if(k===toolKey && isFinite(step)){
          const sp=roundToResolution(ex, step, pol); const d=sp-ex;
          setpointStr=`${(document.documentElement.lang==="es"?"Punto: ":"Setpoint: ")}${fmt(sp,k)} ${u.label}`;
          deltaStr=`Δ ${fmt(d,k)} ${u.label}`;
          perUnit[k]={hasSetpoint:true,setpoint:sp,exactMidOrSingle:ex,delta:d,policy:pol,step:step,label:u.label,basis:"Single"};
        }else perUnit[k]={hasSetpoint:false};
      }else{
        const exLo=u.fromNm(loNm), exMd=u.fromNm(mdNm), exHi=u.fromNm(hiNm);
        exactStr=`${(document.documentElement.lang==="es"?"Bajo ":"Lo ")}${fmt(exLo,k)} • ${(document.documentElement.lang==="es"?"Medio ":"Mid ")}${fmt(exMd,k)} • ${(document.documentElement.lang==="es"?"Alto ":"Hi ")}${fmt(exHi,k)} ${u.label}`;
        if(k===toolKey && isFinite(step)){
          const sp=roundToResolution(exMd, step, pol); const d=sp-exMd;
          setpointStr=`${(document.documentElement.lang==="es"?"Punto (Medio ":"Setpoint (Mid ")}${pol}): ${fmt(sp,k)} ${u.label}`;
          deltaStr=`Δ ${(document.documentElement.lang==="es"?"vs Medio ":"vs Mid ")}${fmt(d,k)} ${u.label}`;
          perUnit[k]={hasSetpoint:true,setpoint:sp,exactMidOrSingle:exMd,delta:d,policy:pol,step:step,label:u.label,basis:"Midpoint"};
        }else perUnit[k]={hasSetpoint:false};
      }
      results.insertAdjacentHTML("beforeend", rowTemplate(u.label, exactStr, setpointStr, deltaStr, k));
    });
  }

  // Copy
  results.addEventListener("click",(e)=>{
    const b=e.target.closest("button[data-unit]"); if(!b) return;
    const key=b.getAttribute("data-unit"); const info=perUnit[key]; if(!info?.hasSetpoint) return;
    const text = `${info.setpoint} ${info.label} — policy=${info.policy}, step=${info.step}, basis=${info.basis}, Δ=${(info.setpoint - info.exactMidOrSingle).toFixed(3)}`;
    navigator.clipboard.writeText(text).then(()=>{const old=b.textContent;b.textContent="Copied";setTimeout(()=>b.textContent=old,1200);});
  });

  // Events
  ["input","change"].forEach(ev=>{
    valueLow.addEventListener(ev, compute);
    valueHigh.addEventListener(ev, compute);
    fromUnit.addEventListener(ev, compute);
    toolUnit.addEventListener(ev, compute);
    resolution.addEventListener(ev, compute);
    policy.addEventListener(ev, compute);
  });

  // Disclaimer Modal
  const modal = $("#disclaimerModal");
  const disclaimerLink = $("#disclaimerLink");
  const closeBtn = $(".close");

  disclaimerLink.addEventListener("click", () => {
    modal.style.display = "block";
  });

  closeBtn.addEventListener("click", () => {
    modal.style.display = "none";
  });

  window.addEventListener("click", (e) => {
    if (e.target === modal) {
      modal.style.display = "none";
    }
  });

  // Close modal with Escape key
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && modal.style.display === "block") {
      modal.style.display = "none";
    }
  });

  // Service worker
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }
  compute();
})();
</script>
</body>
</html>